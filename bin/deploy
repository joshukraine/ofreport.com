#!/usr/bin/env bash

set -e
ENV="$1"
yarn_cmd=$(command -v yarn)
gulp_cmd=$(command -v gulp)
build_dir="dist"

if [[ $# -ne 1 ]]; then
  echo "Please specify an environment."
  exit 1
else
  if [[ "$ENV" =~ ^prod$ ]]; then
    read -p "You are about to deploy to production. Are you sure? (y/n) " -n 1 -r
    echo
    if [[ "$REPLY" =~ ^[Yy]$ ]]; then
      printf "\\n--> Checking for node_modules dependencies...\\n"
      [ ! -d "node_modules" ] && $yarn_cmd install

      printf "\\n--> Generating static site files -> %s/...\\n" "$build_dir"
      APP_ENV="prod" $yarn_cmd generate

      printf "\\n--> Deploying to %s...\\n" "$OFR_PROD_BUCKET_NAME"
      OFR_BUCKET_NAME=$OFR_PROD_BUCKET_NAME $gulp_cmd deploy

      printf "\\n--> Deploy complete!"
      printf "\\n--> http://ofreport.com.s3-website-us-east-1.amazonaws.com/\\n"
      printf "\\n--> https://ofreport.com/\\n"
    fi
  else
    printf "\\n--> Checking for node_modules dependencies...\\n"
    [ ! -d "node_modules" ] && $yarn_cmd install

    printf "\\n--> Generating static site files -> %s/...\\n" "$build_dir"
    APP_ENV=$ENV $yarn_cmd generate

    printf "\\n--> Deploying to %s...\\n" "$OFR_DEV_BUCKET_NAME"
    OFR_BUCKET_NAME=$OFR_DEV_BUCKET_NAME $gulp_cmd deploy

    printf "\\n--> Deploy complete!"
    printf "\\n--> http://%s.s3-website-us-east-1.amazonaws.com/\\n" "$OFR_DEV_BUCKET_NAME"
  fi

  printf "\\n--> Here is the contents of your robots.txt file: (%s/robots.txt)\\n" "$build_dir"
  echo "----------------------------"
  cat $build_dir/robots.txt
  echo
  echo "----------------------------"
fi
